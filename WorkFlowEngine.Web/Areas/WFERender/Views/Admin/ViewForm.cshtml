
@{
    ViewData["Title"] = "ViewForm";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string Glink = Context.Request.Query["Glink"];
    string Plink = Context.Request.Query["Plink"];
    var FormDetails = ViewBag.Form;
}

<div class="row">
    <div class="col-md-12 col-sm-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs" role="tablist">
                    <a id="lnkAdd" href="" class="nav-link active">Add</a>
                    <a id="lnkView" href="" class="nav-link">View</a>
                </ul>
                <div class="mandatory">
                    <p class="ml-2">(*) Indicates Mandatory </p>
                </div>
            </div>
            <div class="card-body">
                @Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[0]))
                <div class='form-group'>
                    @if (ViewBag.Type != "E")
                    {
                        @if (ViewBag.FormType == "API Type")
                        {
                            <input type='button' id='btnSubmitApi' class="btn btn-primary  mr-1 waves-effect waves-float waves-light" value="Submit" />
                        }
                        else
                        {
                            <input type='button' id='btnSubmit' class="btn btn-primary  mr-1 waves-effect waves-float waves-light" value="Submit" />
                        }
                        @*<input type='button' id='btnDraft' class="btn btn-warning  mr-1 waves-effect waves-float waves-light" value="Save As Draft" />*@
                        <input type='button' id='btnCancel' value="Reset" class="btn btn-danger mr-1 waves-effect waves-float waves-light" />
                    }
                </div>
                <div>
                    <input type="hidden" id="hdnid" />
                </div>
            </div>
        </div>
        <div class="card" style="display:none">
            <div class="card-body" id="tblFormView">
            </div>
        </div>
    </div>
</div>
<script>
            $(document).ready(function () {
                 var gl = decodeURI(getUrlVars()["Glink"]);
                 var pl = decodeURI(getUrlVars()["Plink"]);

                 if (gl == 'undefined') {
                     gl = 0;
                 }
                 if (pl == 'undefined') {
                     pl = 0;
                 }
                document.getElementById("lnkAdd").href = "@Url.Action("ViewForm", "Admin", new { Area = "WFERender" })?FormId=" + getUrlVars()["FormId"] + "&name=" + getUrlVars()["name"]+"&Glink="+gl+"&Plink="+pl;
                document.getElementById("lnkView").href = "@Url.Action("FormResultsView", "Admin", new { Area = "WFERender" })?FormId=" + getUrlVars()["FormId"] + "&name=" + getUrlVars()["name"]+"&Glink="+gl+"&Plink="+pl;
                var applicantNo = getUrlVars()["ApplicantNo"];
                if (applicantNo != undefined) {
                    $("#btnSubmit").val("Update");
                    $("#btnSubmit").addClass("btn btn-primary");
                    $("#btnCancel").val("Cancel");
                    //document.getElementById("btnDraft").style.display = "none";
                    //document.getElementById("btnCancel").style.display = "block";
                }
                else {
                    $("#btnDraft").val("Save As Draft");
                    $("#btnSubmit").val("Submit");
                    $("#btnCancel").val("Reset");
                    $("#btnDraft").addClass("btn btn-primary");
                    $("#btnSubmit").addClass("btn btn-primary");
                    //document.getElementById("btnDraft").style.display = "block";
                    //document.getElementById("btnCancel").style.display = "none";
                }
                 $(document).ready(function () {
                     $(document).on('click', '.remove', function () {
                         $(this)[0].parentElement.parentElement.remove();
                     });

                     /*$("#table-data").on('click', 'input.addButton', function () {*/
                     $(document).on('click', '.add-btn', function () {
                         var $table = $(this);
                         var $tr = $table.closest('tr');
                         var allTrs = $tr.closest('table').find('tr');
                         var lastTr = allTrs[allTrs.length - 1];
                         var $clone = $(lastTr).clone();
                         $clone.find('td:last').html("<button class='btn btn-danger btn-sm remove' data-toggle='tooltip' data-placement='top' title='Remove'><i class='fa fa-minus' aria-hidden='true'></i></button>"); //remove the last td from cloned element

                         $clone.find('td').each(function () {
                             var el = $(this).find(':first-child');
                             var id = el.attr('id') || null;
                             var name = el.attr('name');
                             if (id) {
                                     var i = id.substr(id.length - 1);
                                 var prefix = id.substr(0, (id.length - 1));
                                 el.attr('id', prefix + (+i + 1));
                                 if (name != undefined)
                                 {
                                     var j = name.substr(name.length - 1);
                                     var prefix_name = name.substr(0, (name.length - 1));
                                     el.attr('name', prefix_name + (+j + 1));
                                 }
                                 if (el.attr('data') == 'checkdiv') {
                                     if (el[0].children[0].type == "radio") {
                                         var chkname = el[0].children[0].name;
                                         var i = chkname.substr(chkname.length - 1);
                                         var prefix = chkname.substr(0, (chkname.length - 1));
                                         let y = 0;
                                         $("[data=checkdiv]").each(function () {
                                             var dicid = $(this).attr("id")
                                             $("#" + dicid).find('input').attr('name', chkname+y++)
                                         });
                                     }
                                 }
                             }
                         });
                         $clone.find('input').val('');
                         $clone.find('input:checkbox').prop('checked', false);
                         $clone.find('input:radio').prop('checked', false);
                         $tr.closest('table').append($clone);
                     });

                     $("#table-data").on('change', 'select', function () {
                         var val = $(this).val();
                         $(this).closest('tr').find('input:text').val(val);
                     });
    });
            });
            $('#btnDraft').click(function () {
                document.getElementById("hdnid").value = "1";
                submitResult(1, 0);
            });
     $('#btnSubmitApi').click(function () {
        //"SECTORID": 0,
        //    "SECTORNAME": "Test SECTOR API",
        //        "SDATE": "30-MAY-2022",
        //            "CSSCLASS": "Test SECTOR API"
        var Apara ="@Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[9]))";
        var Mapcontrol = "@Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[10]))";
        var Endpoint = "@Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[11]))";
        var Jsondata = "";
        if (Apara != "") {
            for (var i = 0; i < Apara.split(",").length; i++)
            {
                var Cdata = "";
                if (Mapcontrol.split(",")[i] != "0" && Mapcontrol.split(",")[i] != null) {
                    Cdata = "\"" + $("#" + Mapcontrol.split(",")[i] + "").val() + "\"";
                }
                else {
                    Cdata = "\"" + Mapcontrol.split(",")[i] + "\"";
                }
                if (Jsondata == "") {
                    Jsondata = "[{"+"\"" + Apara.split(",")[i] + "\"" + ":" + Cdata;
                }
                else {
                    Jsondata = Jsondata + "," + "\"" + Apara.split(",")[i] + "\"" + ":" + Cdata;
                }
            }
        }
            Jsondata = Jsondata + "}]";
        $.ajax({
            url: Endpoint,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(Jsondata),
            success: function () {
                bootbox.alert("Data Submitted successfully", function () {
                                                window.location.href = "@Url.Action("ViewForm", "Admin", new { Area = "WFERender" })?FormId=" + decodeURI(getUrlVars()["FormId"]) + "&name=" + decodeURI(getUrlVars()["name"] + "&Glink=0&Plink=0");
                                            });
            },
            error: function () {
                alert('error');
            }
        });
    });
            $('#btnSubmit').click(function () {
                var applicantNo = getUrlVars()["ApplicantNo"];
                if (applicantNo != undefined) {
                    submitResult(0, applicantNo);
                }
                else {
                    submitResult(0, 0);
                }
            });
            $('#btnCancel').click(function () {
                var applicantNo = getUrlVars()["ApplicantNo"];
                if (applicantNo != undefined) {
                    window.location.href = "@Url.Action("FormResultsView", "Admin", new { Area = "WFERender" })?FormId=" + getUrlVars()['FormId'] + "&name=" + getUrlVars()["name"] +"&Glink=0&Plink=0";
                }
                else {
                    window.location.href = "@Url.Action("ViewForm", "Admin", new { Area = "WFERender" })?FormId=" + getUrlVars()['FormId'] + "&name=" + getUrlVars()["name"] +"&Glink=0&Plink=0";
                }

            });
            function submitResult(status, appNo) {
                if (appNo == 0) {
                    if (validate()) {
                        if (validateControl()) {
                            bootbox.confirm({
                                size: "medium",
                                message: "Are you sure you want to Submit?",
                                callback: function (result) {
                                    if (result === true) {
                                        var data = "";
                                        var today = new Date();
                                        var dd = String(today.getDate()).padStart(2, '0');
                                        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                                        var yyyy = today.getFullYear();
                                        var timestamp = yyyy + mm + dd + today.getHours() + today.getMinutes() + today.getSeconds();
                                        data=generateJson();
                                        //var data = {"Year":"2020","Month":"February","Remarks":"pppppp"}  {"Year":"P","Month":"P","Remarks":"ppppp"};
                                        var obj = {
                                            "postId": getUrlVars()["FormId"], "formResult": data, "Status": status
                                        };
                                        $.ajax({
                                            type: 'POST',
                                            url: "@Url.Action("InsertFormResult", "Admin")",
                                            data: obj,
                                            dataType: "json",
                                            async: true,
                                            success: function (resultData) {
                                                var Data = (String(resultData)).replace(/\"/g, "");
                                                if (Data == "0") {
                                                     bootbox.alert("Data already exist for the same!", function () {
                                                        window.location.href = "@Url.Action("ViewForm", "Admin", new { Area = "WFERender" })?FormId=" + decodeURI(getUrlVars()["FormId"]) + "&name=" + decodeURI(getUrlVars()["name"] + "&Glink=0&Plink=0");
                                                    });
                                                }
                                                else {
                                                    document.getElementById("hdnid").value = Data;
                                                    bootbox.alert("Data added successfully", function () {
                                                        window.location.href = "@Url.Action("FormResultsView", "Admin", new { Area = "WFERender" })?FormId=" + decodeURI(getUrlVars()["FormId"]) + "&name=" + decodeURI(getUrlVars()["name"] + "&Glink=0&Plink=0");
                                                    });
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    }
                }
                else {
                    if (validate()) {
                        if (validateControl()) {
                        bootbox.confirm({
                            size: "medium",
                            message: "Are you sure you want to update?",
                            callback: function (result) {
                                if (result === true) {
                                            var getdata = "";
                                            var today = new Date();
                                            var dd = String(today.getDate()).padStart(2, '0');
                                            var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                                            var yyyy = today.getFullYear();
                                            var timestamp = yyyy + mm + dd + today.getHours() + today.getMinutes() + today.getSeconds();
                                            if ($('#hdncolumn').val() != "") {
                                                for (var i = 0; i < $('#hdncolumn').val().split(",").length; i++) {
                                                    var ColumnValue = "";
                                                    if ($('input[name='+ $('#hdncolumnid').val().split(",")[i]+']:checked').val() != undefined ) {
                                                        ColumnValue = $('input[name='+ $('#hdncolumnid').val().split(",")[i]+']:checked').val();
                                                    }
                                                    else if ($('#hdncolumntype').val().split(",")[i] == "checkbox") {
                                                        /*ColumnValue = $('input[name=' + $('#hdncolumnid').val().split(",")[i] + ']:checked').val();*/
                                                        var cdata = "";
                                                        if ($("#" + $('#hdncolumnid').val().split(",")[i])[0].children.length > 0) {
                                                            for (var p = 0; p < $("#" + $('#hdncolumnid').val().split(",")[i])[0].children.length; p++) {
                                                                if ($("#" + $('#hdncolumnid').val().split(",")[i])[0].children[p].checked == true) {
                                                                    if (cdata == "") {
                                                                        cdata = $("#" + $('#hdncolumnid').val().split(",")[i])[0].children[p].value;
                                                                    }
                                                                    else {
                                                                        cdata = cdata + "," + $("#" + $('#hdncolumnid').val().split(",")[i])[0].children[p].value;
                                                                    }
                                                                }
                                                            }
                                                            ColumnValue = cdata;
                                                            cdata = "";
                                                        }
                                                    }
                                                    else if ($("#" + $('#hdncolumnid').val().split(",")[i]).val() != "") {
                                                       /* ColumnValue = $("#" + $('#hdncolumnid').val().split(",")[i]).val();*/
                                                        if ($("#" + $('#hdncolumnid').val().split(",")[i])[0].files == undefined) {
                                                            ColumnValue = $("#" + $('#hdncolumnid').val().split(",")[i]).val();
                                                        }
                                                        else {
                                                            /*var fname = $("#" + $('#hdncolumnid').val().split(",")[i])[0].id.split("_")[1];*/
                                                            var fname = $('#hdncolumn').val().split(",")[i];
                                                            var Imgdata = fname + "_" + timestamp + "" + $("#" + $('#hdncolumnid').val().split(",")[i]).val().split("\\")[2];
                                                            ColumnValue = Imgdata;
                                                            var fid = $("#" + $('#hdncolumnid').val().split(",")[i])[0].id;
                                                            var fsize = $("#" + "hdn_" + fname).val().split("&")[0];
                                                            var ftype = $("#" + "hdn_" + fname).val().split("&")[1];
                                                            if (!ValidateFile(fid, 'Valid ' + fname)) {
                                                                return false;
                                                            }
                                                            else {
                                                                if (!CheckFileType(fid, ftype, fsize)) {
                                                                    return false;
                                                                }
                                                                else {
                                                                    UploadFile(getUrlVars()["Formid"], $("#" + $('#hdncolumnid').val().split(",")[i])[0].id, Imgdata, fname);
                                                                }
                                                            }

                                                        }
                                                        if ($('#hdncolumntype').val().split(",")[i] == "datetime-local") {
                                                            ColumnValue = ColumnValue.replace("T", " ")
                                                        }
                                                    }
                                                    else {
                                                        ColumnValue = "";
                                                    }
                                                    if (getdata == "") {
                                                        getdata =   $('#hdncolumn').val().split(",")[i]  + "&"  + ColumnValue ;
                                                    }
                                                    else {
                                                        getdata = getdata + "^" +  $('#hdncolumn').val().split(",")[i] + "&" + ColumnValue;
                                                    }
                                                }
                                                getdata = getdata + "^";
                                            }
                                            var FORMID = parseInt(decodeURI(getUrlVars()["FormId"]));
                                            var data = "";
                                            var data=generateJson();
                                             var obj = {
                                                "FORMID": FORMID, "COLUMNNAME": getdata, "APPLICANT_NO": decodeURI(getUrlVars()["ApplicantNo"]), "formResult": data
                                            };

                                            $.ajax({
                                            type: 'POST',
                                            url: "@Url.Action("UpdateVerifyFormResult", "Admin")",
                                            data: obj,
                                            dataType: "json",
                                            async: true,
                                            success: function (resultData) {
                                                var Data = (String(resultData)).replace(/\"/g, "");
                                                if (Data == "0") {
                                                     bootbox.alert("Data already exist for the same!", function () {
                                                        window.location.href = "@Url.Action("ViewForm", "Admin", new { Area = "WFERender" })?ApplicantNo=" + decodeURI(getUrlVars()["ApplicantNo"]) + "&FormId=" + decodeURI(getUrlVars()["FormId"]) + "&name=" + decodeURI(getUrlVars()["name"] + "&Glink=0&Plink=0");
                                                    });
                                                 }
                                                 else {
                                                    document.getElementById("hdnid").value = Data;
                                                    bootbox.alert("Data updated successfully", function () {
                                                        window.location.href = "@Url.Action("FormResultsView", "Admin", new { Area = "WFERender" })?FormId=" + decodeURI(getUrlVars()["FormId"]) + "&name=" + decodeURI(getUrlVars()["name"] + "&Glink=0&Plink=0");
                                                    });
                                                 }
                                            }
                                           });
                                        }
                            }
                        });
                    }
                }
                }
            }
            function generateJson() {
                var data = ""; var Matrixdata = ""; var Mfinaldata = "";


                    if ($('#hdncolumn').val() != "") {
                        if ($('#hdncolumn').val().includes(",")) {
                            for (var i = 0; i < $('#hdncolumn').val().split(",").length; i++) {
                                var ColumnValue = "";
                                if ($('#hdncolumntype').val().split(",")[i] == "matrixdynamic") {
                                    for (var j = 0; j < $('#' + $('#hdncolumn').val().split(",")[i] + ' tbody tr:not(:empty)').length; j++) {
                                        if (Matrixdata == "") {
                                            Matrixdata = "{";
                                        }
                                        else {
                                            Matrixdata = Matrixdata + ",{";
                                        }
                                        for (var k = 0; k < $('#' + $('#hdncolumn').val().split(",")[i] + ' thead tr th').length - 1; k++) {
                                            var fid = $('#hdncolumn').val().split(",")[i] + "_" + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].children[0].value.replace(" ", "") + "_" + j;
                                            if ($('#' + $('#hdncolumn').val().split(",")[i] + ' thead tr th')[k].children[1].value == "file") {
                                                var today = new Date();
                                                var dd = String(today.getDate()).padStart(2, '0');
                                                var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                                                var yyyy = today.getFullYear();
                                                var timestamp = yyyy + mm + dd + today.getHours() + today.getMinutes() + today.getSeconds();
                                                var fname = $('#hdncolumn').val().split(",")[i] + "_" + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].innerText;
                                                var Imgdata = "";
                                                if ($("#" + fid).val() == "" || $("#" + fid).val() == undefined) {
                                                    Imgdata = $("#" + fid)[0].defaultValue;
                                                }
                                                else {
                                                    Imgdata = fname + "_" + timestamp + "" + $("#" + fid).val().split("\\")[2];
                                                }
                                                ColumnValue = Imgdata;

                                                //var fsize = $("#" + "hdn_" + fname).val().split("&")[0];
                                                //var ftype = $("#" + "hdn_" + fname).val().split("&")[1];
                                                if (!ValidateFile(fid, 'Valid ' + fname)) {
                                                    return false;
                                                } else {
                                                    //if (!CheckFileType(fid, ftype, fsize)) {
                                                    //    return false;
                                                    //} else {
                                                    UploadFile(getUrlVars()["FormId"], fid, Imgdata, fname);
                                                    // }
                                                }
                                                if (k == 0) {
                                                    Matrixdata = Matrixdata + '"' + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].children[0].value + '"' + ":" + '"' + ColumnValue + '"';
                                                } else {
                                                    Matrixdata = Matrixdata + "," + '"' + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].children[0].value + '"' + ":" + '"' + ColumnValue + '"';
                                                }
                                            }
                                            else if ($('#' + $('#hdncolumn').val().split(",")[i] + ' thead tr th')[k].children[1].value == "checkbox" || $('#' + $('#hdncolumn').val().split(",")[i] + ' thead tr th')[k].children[1].value == "radiogroup") {
                                                var cdata = "";
                                                if ($("#" + fid)[0].children.length > 0) {
                                                    for (var p = 0; p < $("#" + fid)[0].children.length; p++) {
                                                        if ($("#" + fid)[0].children[p].checked == true) {
                                                            if (cdata == "") {
                                                                cdata = $("#" + fid)[0].children[p].value;
                                                            }
                                                            else {
                                                                cdata = cdata + "," + $("#" + fid)[0].children[p].value;
                                                            }
                                                        }
                                                    }
                                                    if (k == 0) {
                                                        Matrixdata = Matrixdata + '"' + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].children[0].value + '"' + ":" + '"' + cdata + '"';
                                                    } else {
                                                        Matrixdata = Matrixdata + "," + '"' + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].children[0].value + '"' + ":" + '"' + cdata + '"';
                                                    }
                                                }
                                            }
                                            else {
                                                if (k == 0) {
                                                    Matrixdata = Matrixdata + '"' + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].children[0].value + '"' + ":" + '"' + $('#' + fid).val() + '"';
                                                } else {
                                                    Matrixdata = Matrixdata + "," + '"' + $('#' + $('#hdncolumn').val().split(",")[i] + ' thead th')[k].children[0].value + '"' + ":" + '"' + $('#' + fid).val() + '"';
                                                }
                                            }
                                        }
                                        Matrixdata = Matrixdata + "}";
                                    }
                                    //Matrixdata = '"' + $('#hdncolumn').val().split(",")[i] + '"' + ":" + Matrixdata;
                                    if (Mfinaldata == "") {
                                        Mfinaldata = '"' + $('#hdncolumn').val().split(",")[i] + '"' + ":" + Matrixdata;
                                    }
                                    else {
                                        Mfinaldata = Mfinaldata + "|" + '"' + $('#hdncolumn').val().split(",")[i] + '"' + ":" + Matrixdata;
                                    }
                                    Matrixdata = "";
                                }
                                else if ($('#hdncolumntype').val().split(",")[i] == "checkbox") {
                                    /*ColumnValue = $('input[name=' + $('#hdncolumnid').val().split(",")[i] + ']:checked').val();*/
                                    var cdata = "";
                                    if ($("#" + $('#hdncolumnid').val().split(",")[i])[0].children.length > 0) {
                                        for (var p = 0; p < $("#" + $('#hdncolumnid').val().split(",")[i])[0].children.length; p++) {
                                            if ($("#" + $('#hdncolumnid').val().split(",")[i])[0].children[p].checked == true) {
                                                if (cdata == "") {
                                                    cdata = $("#" + $('#hdncolumnid').val().split(",")[i])[0].children[p].value;
                                                }
                                                else {
                                                    cdata = cdata + "," + $("#" + $('#hdncolumnid').val().split(",")[i])[0].children[p].value;
                                                }
                                            }
                                        }
                                        ColumnValue = cdata;
                                        cdata = "";
                                    }
                                }
                                else if ($('input[name=' + $('#hdncolumnid').val().split(",")[i] + ']:checked').val() != undefined) {
                                    ColumnValue = $('input[name=' + $('#hdncolumnid').val().split(",")[i] + ']:checked').val();
                                }
                                else if ($("#" + $('#hdncolumnid').val().split(",")[i]).val() != "") {
                                    /*  ColumnValue = $("#" + $('#hdncolumnid').val().split(",")[i]).val();*/

                                    if ($('#hdncolumntype').val().split(",")[i] != "file") {

                                        ColumnValue = $("#" + $('#hdncolumnid').val().split(",")[i]).val();
                                    }
                                    else {
                                        var today = new Date();
                                        var dd = String(today.getDate()).padStart(2, '0');
                                        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                                        var yyyy = today.getFullYear();
                                        var timestamp = yyyy + mm + dd + today.getHours() + today.getMinutes() + today.getSeconds();
                                        var fname = $('#hdncolumn').val().split(",")[i];
                                        var Imgdata = fname + "_" + timestamp + "" + $("#" + $('#hdncolumnid').val().split(",")[i]).val().split("\\")[2];
                                        ColumnValue = Imgdata;
                                        var fid = $("#" + $('#hdncolumnid').val().split(",")[i])[0].id;
                                        var fsize = $("#" + "hdn_" + fname).val().split("&")[0];
                                        var ftype = $("#" + "hdn_" + fname).val().split("&")[1];
                                        if (!ValidateFile(fid, 'Valid ' + fname)) {
                                            return false;
                                        } else {
                                            if (!CheckFileType(fid, ftype, fsize)) {
                                                return false;
                                            } else {
                                                UploadFile(getUrlVars()["FormId"], $("#" + $('#hdncolumnid').val().split(",")[i])[0].id, Imgdata, fname);
                                            }
                                        }

                                    }
                                    if ($('#hdncolumntype').val().split(",")[i] == "datetime-local") {
                                        ColumnValue = ColumnValue.replace("T", " ")
                                    }
                                }
                                else {
                                    ColumnValue = "";
                                }

                                if (data == "") {
                                    data = "{" + '"' + $('#hdncolumn').val().split(",")[i] + '"' + ":" + '"' + ColumnValue + '"';
                                } else {
                                    data = data + "," + '"' + $('#hdncolumn').val().split(",")[i] + '"' + ":" + '"' + ColumnValue + '"';
                                }


                                //if (Matrixdata == "") {
                                //    Matrixdata = "{" + '"' + $('#hdncolumn').val().split(",")[i] + '"' + ":" + '"' + Matrixdata + '"';
                                //    } else {
                                //    Matrixdata = Matrixdata + "," + '"' + $('#hdncolumn').val().split(",")[i] + '"' + ":" + '"' + Matrixdata + '"';
                                //    }

                            }

                            data = data + "}";
                            //Matrixdata = Matrixdata + "}";
                        }
                        else {
                            ColumnValue = $("#" + $('#hdncolumnid').val()).val();
                            if (data == "") {
                                data = "{" + '"' + $('#hdncolumn').val() + '"' + ":" + '"' + ColumnValue + '"';
                            } else {
                                data = data + "," + '"' + $('#hdncolumn').val() + '"' + ":" + '"' + ColumnValue + '"';
                            }
                            data = data + "}";
                        }

                }
                return data + "|" + Mfinaldata;
    }
            function getUrlVars() {
                var vars = [], hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                }
                return vars;
            }
            function UploadFile(FormId, ImgId, ImgName,Filename) {

                var fileData = new FormData(); //Creating FormData Object to fill the values entered by the  user for insert into the database
                fileData.append("postId", FormId);
                fileData.append("Filename", ImgName);
                fileData.append("Foldername", Filename);
                if (window.FormData !== undefined) {
                    var fileUpload = $("#" + ImgId).get(0);

                    var files = fileUpload.files;
                    if (files.length > 0) {
                        for (var i = 0; i < files.length; i++) {
                            fileData.append(files[i].name, files[i]);
                        }
                    }
                }


                $.ajax({
                    type: "POST",
                    url: "/Admin/UploadFile",
                        //"@Url.Action("UploadFile", "Admin")",

                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                    data: fileData,
                    contentType: false, // Not to set any content header
                    processData: false, // Not to process data
                    success: function (data) {
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        // TODO: Show error

                    }
                });

            }
        function ValidateFile(cntr, strText) {
            var strValue = $('#' + cntr).get(0).files.length;
            var Dfltvalue = $('#' + cntr)[0].defaultValue;
            if (strValue == "0" && Dfltvalue=="") {
                bootbox.alert("Please upload " + strText);
                $('#fuUploadPocPrev').text("Choose File");
                return false;
            }
            else
                return true;
        }
        function CheckFileType(cntr, ftype,fsize) {
            var userImg = '@Url.Content("~/imgs/no_user.png")';
            // Get the file upload control file extension
            var extn = $('#' + cntr).val().split('.').pop().toLowerCase();
            if (extn != '') {

                if (ftype.replace(/\"/g, "").toLowerCase().indexOf(extn) <= 0)
                {
                    bootbox.alert('Please upload a valid document of type ' + ftype + '!!!');
                    $('#' + cntr).replaceWith($('#' + cntr).val('').clone(true));
                    $('#' + cntr).focus();
                }
                else {
                    // Restrict the file size to 2MB(1024 * 5120;)
                    if ($('#' + cntr).get(0).files[0].size > (1048576 * (parseInt(fsize)))) {
                        bootbox.alert("<strong>Proceeding file size should not exceed " + fsize + "MB.!!!</strong>");
                        //$('#fuUploadPocPrev').text("Choose File");
                        $('#' + cntr).replaceWith($('#' + cntr).val('').clone(true));
                        $('#' + cntr).focus();
                    }
                    if ($('#' + cntr).get(0).files[0].name.length > 100) {
                        bootbox.alert("<strong>Proceeding file Name should be maximum 100 Characters!</strong>");
                        //$('#fuUploadPocPrev').text("Choose File");
                        $('#' + cntr).replaceWith($('#' + cntr).val('').clone(true));
                        //$('label[id*="' + cntr + '"]').text('');
                        $('#' + cntr).focus();
                    }
                    else
                        return true;
                }
            }
            else
                return true;
            }
            function tableToJson(table,FormId) {
            var data = [];
            for (var i=1; i<table[0].rows.length; i++) {
                var tableRow = table[0].rows[i];
                var rowData = [];
                for (var j = 1; j < tableRow.cells.length - 1; j++) {
                    if (tableRow.cells[j].children[0].files != null) {
                        var today = new Date();
                        var dd = String(today.getDate()).padStart(2, '0');
                        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                        var yyyy = today.getFullYear();
                        var timestamp = yyyy + mm + dd + today.getHours() + today.getMinutes() + today.getSeconds();
                        var Gid = $("#" + tableRow.cells[j].children[0].id + "")[0].id;
                        var fname = Gid.split("_")[2] + "_" + Gid.split("_")[1];
                       var Imgdata = fname + "_" + timestamp + "" + $("#" + tableRow.cells[j].children[0].id).val().split("\\")[2];
                        UploadFile(FormId, Gid, Imgdata, fname);
                         rowData.push("'" + Imgdata + "'" );
                    }
                    else {
                        rowData.push("'" + $("#" + tableRow.cells[j].children[0].id + "").val() + "'");
                    }
                }
                data.push(rowData+"=");
            }
            return data;
        }
</script>
@*Dynamic Script to validate the required fields*@
<script>
    @Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[1]))
    @Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[6]))
</script>
@*Stylesheet Url*@
@if (FormDetails.Split("|")[2] != "#")
{
    @*@Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[2]))*@
    <link href="@ViewBag.UploadPath/TemplateDocuments/@FormDetails.Split("|")[2]" rel='stylesheet' />
}
@*Dynamic Script for expressions for calculations in the forms*@
@if (FormDetails.Split("|")[3] != "")
{
    <script>

        @Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[3]))

    </script>
}
@*Script File uploaded with the form*@
@if (FormDetails.Split("|")[4] != "#")
{
    <script src="@ViewBag.UploadPath/ScriptDocuments/@FormDetails.Split("|")[4]"></script>
}
@*Dynamic Script casecading fields*@
<script>
    function keysToUppercase(j) {
        if (typeof j === 'string') { // so it works for javascript arrays as well
            try {
                j = JSON.parse(j);
            } catch (err) {
                console.error('Invalid JSON input');
                console.error(err);
            }
        }
        j = j.map(x => {
            for (let prop in x) {
                x[prop.toUpperCase()] = x[prop];
                delete x[prop];
            }
            return x;
        })
        return j;
    }

    @Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[5]))

</script>
<script>
    @Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[7]))
</script>
<script>
    @Html.Raw(System.Web.HttpUtility.HtmlDecode(FormDetails.Split("|")[12]))
</script>
